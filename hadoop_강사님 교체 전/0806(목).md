## 0806(목) 

#### Flume (72p)

------

> Apache Flume

- 오픈소스 프로젝트로 개발된 로그 데이터 수집 기술이다. 
- 여러 서버에서 생상된 대용량 로그 데이터를 효과적으로 수집하여, HDFS과 같은 원격 목적지에 데이터를 전송하는 기능을 제공한다. 
- 구조가 단순하고 유연하여 다양한 유형의 스트리밍 데이터 플로우 아키텍처를 구성할 수 있다.
- 로그 수집에 Flume을 사용함으로써 신뢰성, 규모 확장성 및 기능 확장성을 확보할 수 있다.
- Flume을 사용하면 장애 시에도 수집된 로그 유실을 방지할 수 있으며, Scale-up/Scale-out 방식의 확장을 모두 지원한다. 마지막으로 새로운 기능을 쉽게 커스터마이징 할 수 있다.

![image-20200806123448487](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806123448487.png)

- Flume은 자바로 작성된 유연한 로그 수집 툴이다.

![image-20200806123519623](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806123519623.png)

- Flume의 핵심 구성 요소는 Source, Channel, Sink다. (Source와 Sink는 개별적인 쓰레드로 동작한다.)
  - Source : 외부 이벤트가 생성되어 수집되는 영역  / 1개 구성, 복수 Channel 지정
  - Channel : Source와 Sink 간의 버퍼 구간 / 채널 별로 1개 Sink 지정
  - Sink : 수집된 로그/이벤트를 목적지에 전달
  - Interceptor : 수집된 로그/이벤트 가공

> 설정

<master>

- apache-flume-1.9.0-bin.tar 파일 
- copy

![image-20200806102819205](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806102819205.png)

![image-20200806102851468](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806102851468.png)

- 압축 풀기

![image-20200806102926265](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806102926265.png)

- 폴더명 변경(편의성)

![image-20200806103036139](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806103036139.png)

- 

![image-20200806103114312](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806103114312.png)

![image-20200806103252711](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806103252711.png)

- source를 사용하여 현재 터미널에 적용(임시) 한 후 버전 확인

![image-20200806103355226](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806103355226.png)

- 파일 생성 후 설정

![image-20200806103644309](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806103644309.png)

![image-20200806104709213](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806104709213.png)

agent1 : 최상위 에이전트 명 / 단일 에이전트

source1 : 에이전트에서 실행된 소스의 이름을 나열 / 단일 소스

spooldir : 새로운 파일의 전송을 위해 스풀링 디렉터리를 검사하는 스풀링 디렉터리 소스

spoolDir : 스풀링 디렉터리 소스를 지정

logger : 콘솔에 이벤트를 기록하는 로거 싱커

channel1 : 싱크는 반드시 채널과 연결해야 한다. 파일 채널을 사용하면 파일로 저장 

![image-20200806104523947](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806104523947.png)

- 스풀링 데렉터리 생성

![image-20200806104939493](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806104939493.png)

- flume 실행(대기상태가 된다) 

![image-20200806110811182](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806110811182.png)

- 새터미널(new) 실행

![image-20200806111221243](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806111221243.png)

- 숨긴 폴더 생성 (new)

![image-20200806111310045](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806111310045.png)

![image-20200806111340814](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806111340814.png)

- 파일 안에 내용 넣고 출력(new)

![image-20200806111445373](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806111445373.png)

- 파일 내용 확인(new)

![image-20200806111608324](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806111608324.png)

- 숨긴 파일을 일반 파일로 변경(확장자가 자동으로 추가됨) (new)

![image-20200806111727837](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806111727837.png)

![image-20200806111758398](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806111758398.png)

- 전의 터미널 창에서 진행사항이 출력 됨 (old)

![image-20200806111850514](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806111850514.png)



> HDFS 싱크

- 원래의 터미널(old) ctrl+c로 빠져나오기
- 설정 파일 copy (old)

![image-20200806115546375](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806115546375.png)

- 설정 파일 열기 (수집된 로그/이벤트를 지정한 목적지에 전달)

![image-20200806115642302](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806115642302.png)

![image-20200806115958275](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806115958275.png)

- 폴더 생성

![image-20200806120537654](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806120537654.png)

- 

![image-20200806120626423](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806120626423.png)

- 

![image-20200806120941106](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806120941106.png)

- 새로운 터미널 창에서 작업(new)

![image-20200806121050382](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806121050382.png)

- 아무 파일도 없는 것을 확인(new)

![image-20200806121124126](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806121124126.png)

- 현재폴더 밑에 있는 flume / spool 에 data.log를 copy (new)

![image-20200806121241430](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806121241430.png)

뒤의 창(old)에서 현재 진행 상태를 보여줌

- (Error) copy가 진행되지 않음 - (해결방안) guava 파일 삭제

![image-20200806123851730](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806123851730.png)

- 재가동

![image-20200806120941106](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806120941106.png)

- 하둡 폴더에 수집되어 저장된 로그 파일 확인

![image-20200806124238100](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806124238100.png)

![image-20200806141102006](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806141102006.png)

- 전부 삭제(데이터 많아서)

![image-20200806140740417](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806140740417.png)



> 분기 : 하나의 소스에서 발생한 이벤트를 여러 개의 채널로 전송하는 것을 의미

![image-20200806144050229](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806144050229.png)



> 분배 : 에이전트 계층

- 모든 노드마다 한 개의 에이전트가 실행중이므로 HDFS에 기록하는 것보다는 노드 그룹에서 발생하는 이벤트를 하나의 파일로 모으는 방법이 효율적이다.
- 여러 노드의 이벤트를 모으려면 플룸 에이전트 계층을 구성해야 한다.
- 첫 번째 계층의 이벤트를 두 번재 계층으로 전송하고 두 번째 계층은 이벤트를 모아 HDFS에 쓴다.
- 에이브로 싱크와 소스는 에이브로 파일을 쓰거나 읽는 기능을 제공하지 않는다. 단지, 에이전트 계층 사이에서 이벤트를 분해하는데 사용되며 통신을 위해 에이브로 RPC를 사용할 뿐이다.

![image-20200806143918400](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806143918400.png)

<master>

- 파일 복사

![image-20200806141500867](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806141500867.png)

- 설정

![image-20200806141628378](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806141628378.png)

![image-20200806143002976](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806143002976.png)

![image-20200806143041291](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806143041291.png)

- 폴더 생성

![image-20200806143207231](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806143207231.png)

- 확인

![image-20200806143300146](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806143300146.png)

- 서버 실행하여 진행사항 확인

![image-20200806143724405](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806143724405.png)

- 새로운 터미널 실행 

![image-20200806145922366](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806145922366.png)

- 만약 실행 안 될 경우 

![image-20200806150125568](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806150125568.png)

- data.log 5줄만 copy

![image-20200806151241016](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806151241016.png)

- 스풀에 copy

![image-20200806151333747](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806151333747.png)

- 확인

![image-20200806151836704](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806151836704.png)

- 내용 읽기

![image-20200806151818393](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806151818393.png)

<master>

- 권한 설정

![image-20200806154555525](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806154555525.png)

<worker>

- 

![image-20200806154814756](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806154814756.png)

- 설정 : server 지우기 (encore를 share로 변경 )

![image-20200806154850609](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806154850609.png)

![image-20200806155026609](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806155026609.png)

- 폴더 생성

![image-20200806155126471](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806155126471.png)

- 권한 

![image-20200806155151250](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806155151250.png)

- 파일 생성

![image-20200806155256975](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806155256975.png)

- apache-flume-1.9.0-bin.tar 파일 (encore에 넣어놓기)

![image-20200806155508675](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806155508675.png)

- 압축 풀기

![image-20200806155537709](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806155537709.png)

- 이름 변경

![image-20200806160817438](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806160817438.png)

- 설정

![image-20200806155645598](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806155645598.png)

![image-20200806161053347](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806161053347.png)

- 임시로 설정파일 적용

![image-20200806155819802](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806155819802.png)

- 실행

![image-20200806160905894](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806160905894.png)

- 새 터미널 열기 (파일 이동)

![image-20200806161238787](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806161238787.png)

![image-20200806161304604](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806161304604.png)

- 확인 (아래가 새로 생긴 파일)

![image-20200806161348929](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806161348929.png)

- 내용 확인 (아래부터 새로 생김)

![image-20200806161525512](C:\Users\whtpw\AppData\Roaming\Typora\typora-user-images\image-20200806161525512.png)